<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
<meta charset=utf-8>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=apple-touch-icon sizes=180x180 href=https://crmejia.github.io/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://crmejia.github.io/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://crmejia.github.io/favicon-16x16.png>
<link rel=manifest href=https://crmejia.github.io/site.webmanifest>
<link rel=mask-icon href=https://crmejia.github.io/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<meta name=keywords content="AWS,
Infrastructure,
Terraform,
">
<meta property="og:title" content="Creating a Simple Cluster with Terraform">
<meta property="og:description" content="Since my last post I’ve been reading about Consul. Also, I found an interesting book: Site Reliability Engineering by Google. So far I’ve read the intro and first chapter and I’m captivated. I want to take my career into SRE/DevOps and this book provides good insight. However, this post is about Terraform, I found a great blog and learned more about it.
The Case for Terraform I found a great series of posts by the engineers at Gruntwork called A Comprehensive Guide to Terraform.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://crmejia.github.io/posts/creating-a-simple-cluster-with-terraform/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-09-19T00:41:29+00:00">
<meta property="article:modified_time" content="2017-09-19T00:41:29+00:00">
<meta property="og:site_name" content="Crismar.Me">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Creating a Simple Cluster with Terraform">
<meta name=twitter:description content="Since my last post I’ve been reading about Consul. Also, I found an interesting book: Site Reliability Engineering by Google. So far I’ve read the intro and first chapter and I’m captivated. I want to take my career into SRE/DevOps and this book provides good insight. However, this post is about Terraform, I found a great blog and learned more about it.
The Case for Terraform I found a great series of posts by the engineers at Gruntwork called A Comprehensive Guide to Terraform.">
<meta itemprop=name content="Creating a Simple Cluster with Terraform">
<meta itemprop=description content="Since my last post I’ve been reading about Consul. Also, I found an interesting book: Site Reliability Engineering by Google. So far I’ve read the intro and first chapter and I’m captivated. I want to take my career into SRE/DevOps and this book provides good insight. However, this post is about Terraform, I found a great blog and learned more about it.
The Case for Terraform I found a great series of posts by the engineers at Gruntwork called A Comprehensive Guide to Terraform."><meta itemprop=datePublished content="2017-09-19T00:41:29+00:00">
<meta itemprop=dateModified content="2017-09-19T00:41:29+00:00">
<meta itemprop=wordCount content="769">
<meta itemprop=keywords content="AWS,Infrastructure,Terraform,">
<title>Creating a Simple Cluster with Terraform || Crismar.Me</title>
<link rel=canonical href=https://crmejia.github.io/posts/creating-a-simple-cluster-with-terraform/>
<link rel=stylesheet href=/css/reboot.css>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/syntax.css>
<script type=text/javascript src=/js/main.js></script>
<link href="https://fonts.googleapis.com/css?family=Lora&display=swap" rel=stylesheet>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/apple-touch-icon.png>
</head>
<body class=look-sheet-bkg lang=en-us>
<div class="navbar nav-bkg drop-shadow">
<nav class="content-container pagewide-bar-padding">
<span class=divider>/ </span>
<a href=/>Crismar.Me</a>
<span class=divider>/ </span>
<a href=/posts/>Posts</a>
<ul class="list-unstyled right-links">
<li>
<a href=/about/>
<span class=post-title>about</span>
</a>
</li>
<li>
<a href=/posts/>
<span class=post-title>blog</span>
</a>
</li>
<li>
<a href=/consulting/>
<span class=post-title>consulting</span>
</a>
</li>
</ul>
</nav>
</div>
<article id=main class="content-container look-sheet article-pad-v" itemscope itemtype=https://schema.org/Article>
<meta itemprop=author content>
<meta itemprop=publisher content>
<meta itemprop=image content>
<h1 itemprop=name id=title>Creating a Simple Cluster with Terraform</h1>
<meta itemprop=headline content="Creating a Simple Cluster with Terraform">
<div class=post-tags>
<a href=https://crmejia.github.io/tags/aws/>#AWS</a>&nbsp;
<a href=https://crmejia.github.io/tags/infrastructure/>#Infrastructure</a>&nbsp;
<a href=https://crmejia.github.io/tags/terraform/>#Terraform</a>&nbsp;
</div>
<div class=post-date><span itemprop=datePublished>September 19, 2017</span></div>
<meta itemprop=dateModified content="September 19, 2017">
<div itemprop=articleBody id=content class="article-body margin-top-2em">
<p>Since my last post I’ve been reading about <a href=https://www.consul.io/intro/index.html>Consul</a>. Also, I found an interesting book: <a href=https://landing.google.com/sre/book.html>Site Reliability Engineering </a>by Google. So far I’ve read the intro and first chapter and I’m captivated. I want to take my career into SRE/DevOps and this book provides good insight. However, this post is about Terraform, I found a great blog and learned more about it.</p>
<h2 id=the-case-for-terraform>The Case for Terraform</h2>
<p>I found a great series of posts by the engineers at Gruntwork called <a href=https://blog.gruntwork.io/a-comprehensive-guide-to-terraform-b3d32832baca>A Comprehensive Guide to Terraform.</a> In the first <a href=https://blog.gruntwork.io/why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation-7989dad2865c>post,</a> the author talks about their choice to use Terraform. Interestingly, the article describes trade-offs between Terraform and other choices as:</p>
<ul>
<li>Configuration Management vs Orchestration</li>
<li>Mutable Infrastructure vs Immutable Infrastructure</li>
<li>Procedural vs Declarative</li>
<li>Client/Server Architecture vs Client-Only Architecture</li>
</ul>
<p>I really liked this approach because I learned about how other technologies approach the IAC(Infrastructure As Code) problem in comparison with Terraform. Technologies such as Chef, Puppet, Ansible,etc., are now a clearer in how they work and where they might be the right solution.</p>
<h2 id=the-guide-that-i-found-after-my-initial-post>The Guide That I found After My Initial Post</h2>
<p>The <a href=https://blog.gruntwork.io/an-introduction-to-terraform-f17df9c6d180>second post</a> of the series is an i ntro guide to Terraform just like my previous post. Yet I learned new things while going through it. First new thing I learned, is to set up a new AWS user with limited power instead of using the root account that is created by default. This is described further in the <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html>AWS IAM(Identity and Access Management) Best Practices guide</a>. I had to delete my root key as a security measure and then create a new user. See <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html>Creating Your First IAM Admin User and Group</a>. Also, I learned how to name an AWS instance with a ‘tag’.</p>
<p>After creating an initial instance, the guide goes further by deploying a simple web server. First, we make use of an EC2’s User Data to run a simple script at launch that starts our server. Then we create a new resource, a security group, to allow our server to be reached from any IP through port 8080. After<code>$terraform apply</code> we can hit our web server with<code>$curl</code>http<code>://&lt;EC2_INSTANCE_PUBLIC_IP>:8080</code>. The public IP address is set as an output in the tf file.</p>
<p>The guide goes on to create a cluster of web servers using an AWS Auto Scaling Group(ASG), which takes care of starting/restarting instances, monitoring health, and adjusting scale based on demand. We start by replacing the “aws_instance” with an “aws_launch_configuration”. This new resource configuration is similar to the aws_instance with the addition of the “lifecycle” block. Alas, we must add this new block to all resources on which the new resource depends on. In this case, we must add it to the aws_security_group. Then we add the ASG resource as “aws_autoscaling_group”. Finally, we use a data_source to fetch all the availability zones from AWS and use them within our ASG as availability_zones = [“${data.aws_availability_zones.all.names}”]. This new variable allows our EC2 instances to be deployed in different(isolated) data centers.</p>
<p>We need two more resources. First, since we have multiple instances running we need a load balancer to distribute the traffic to our instances. For this example, we use AWS very own load balancer, Elastic Load Balancer(ELB). As part of the configuration, we add a “listener” to tell the load balancer how to route incoming requests. In this case, we simply route port 80(HTTP) on the ELB to our instances’ port 8080(set in the variable server_port). The second resource is a new security group to enable traffic to the load balancer. The guide goes on to add “health_check” on the load balancer. This requires outbound traffic to be enabled as an ‘egress’ on the security group. Finally, we must register the instances with the ELB everytime a new instance is created. We do this by adding health_check_type = “ELB” to the ASG configuration. Finally, we add the ELB DNS as output to be able to test our deployment. Hit <code>$terraform plan</code> and if everything looks good <code>$terraform apply</code>. As the resources are being created can check the console for the resources. Once the instances are running we can <code>$curl </code>http<code>://&lt;elb_dns_name></code> and expect “Hello,  Word” back.</p>
<h2 id=conclusion>Conclusion</h2>
<p>I learned  more about Terraform and AWS with these two posts. I’m impressed by the way we could deploy a simple cluster with a few lines of code thanks to Terraform and AWS.  We even had health checks! Well, I’m wrapping up this post at 30,000(28,014)ft feet in the air on my way to Austin for Hashiconf. Hopefully, I’ll learn more about Terraform and the other solutions from Hashicorp as well as meeting some smart people. Catch you on the next one!</p>
</div>
</article>
<div class="nav-bkg-50 content-container-narrow-pad bottom-links text-0p75 drop-shadow">
<nav class=flex-row>
<a href=https://crmejia.github.io/posts/creating-infrastructure-with-terraform/ class="flex-row v-center no-underline" style=max-width:45%>
<span class=text-1p5>←</span>&nbsp;<span class=re-underline>Previous: Creating Infrastructure with Terraform</span>
</a>
<a href=https://crmejia.github.io/posts/my-hashiconf-17-experience/ class="flex-row v-center no-underline" style=max-width:45%>
<span class=re-underline>Next: My Hashiconf '17 Experience</span>&nbsp;<span class=text-1p5>→</span>
</a>
</nav>
</div>
</body>
</html>
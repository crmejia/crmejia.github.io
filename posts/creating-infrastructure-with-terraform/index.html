<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
<meta charset=utf-8>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=apple-touch-icon sizes=180x180 href=https://crmejia.github.io/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://crmejia.github.io/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://crmejia.github.io/favicon-16x16.png>
<link rel=manifest href=https://crmejia.github.io/site.webmanifest>
<link rel=mask-icon href=https://crmejia.github.io/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<meta name=description content="Creating Infrastructure with Terraform">
<meta name=keywords content="AWS,
Infrastructure,
">
<meta property="og:title" content="Creating Infrastructure with Terraform">
<meta property="og:description" content="Creating Infrastructure with Terraform">
<meta property="og:type" content="article">
<meta property="og:url" content="https://crmejia.github.io/posts/creating-infrastructure-with-terraform/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-09-03T20:15:56+00:00">
<meta property="article:modified_time" content="2017-09-03T20:15:56+00:00">
<meta property="og:site_name" content="Crismar.Me">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Creating Infrastructure with Terraform">
<meta name=twitter:description content="Creating Infrastructure with Terraform">
<meta itemprop=name content="Creating Infrastructure with Terraform">
<meta itemprop=description content="Creating Infrastructure with Terraform"><meta itemprop=datePublished content="2017-09-03T20:15:56+00:00">
<meta itemprop=dateModified content="2017-09-03T20:15:56+00:00">
<meta itemprop=wordCount content="1301">
<meta itemprop=keywords content="AWS,Infrastructure,">
<title>Creating Infrastructure with Terraform || Crismar.Me</title>
<link rel=canonical href=https://crmejia.github.io/posts/creating-infrastructure-with-terraform/>
<link rel=stylesheet href=/css/reboot.css>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/syntax.css>
<script type=text/javascript src=/js/main.js></script>
<link href="https://fonts.googleapis.com/css?family=Lora&display=swap" rel=stylesheet>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/apple-touch-icon.png>
</head>
<body class=look-sheet-bkg lang=en-us>
<div class="navbar nav-bkg drop-shadow">
<nav class="content-container pagewide-bar-padding">
<span class=divider>/ </span>
<a href=/>Crismar.Me</a>
<span class=divider>/ </span>
<a href=/posts/>Posts</a>
<ul class="list-unstyled right-links">
<li>
<a href=/about/>
<span class=post-title>about</span>
</a>
</li>
<li>
<a href=/posts/>
<span class=post-title>blog</span>
</a>
</li>
<li>
<a href=/consulting/>
<span class=post-title>consulting</span>
</a>
</li>
</ul>
</nav>
</div>
<article id=main class="content-container look-sheet article-pad-v" itemscope itemtype=https://schema.org/Article>
<meta itemprop=author content>
<meta itemprop=publisher content>
<meta itemprop=image content>
<h1 itemprop=name id=title>Creating Infrastructure with Terraform</h1>
<meta itemprop=headline content="Creating Infrastructure with Terraform">
<div class=post-tags>
<a href=https://crmejia.github.io/tags/aws/>#AWS</a>&nbsp;
<a href=https://crmejia.github.io/tags/infrastructure/>#Infrastructure</a>&nbsp;
</div>
<div class=post-date><span itemprop=datePublished>September 3, 2017</span></div>
<meta itemprop=dateModified content="September 3, 2017">
<div itemprop=articleBody id=content class="article-body margin-top-2em">
<p>I’m attending HashiConf ‘17, an annual tech conference from HashiCorp. I came across HashiCorp sometime ago when I was playing around with Vagrant, a neat tool for creating and managing dev environments using virtual machines. I became aware of the conference thanks to Twitter and reached out to the organizers asking if there was any financial aid or scholarships. Lucky for me, I was offered a complimentary ticket to attend. So here I come HashiConf ‘17!</p>
<h2 id=terraform>Terraform</h2>
<p>Since I’m attending the conference I want to become familiar with other HashiCorp products. I’m going to start with Terraform following the intro <a href=https://www.terraform.io/intro/index.html>guide</a> on Terraform.io. According to the guide, Terraform is a tool for building, changing, and versioning infrastructure safely and efficiently. It can manage popular services providers as well as custom solutions.</p>
<h3 id=install--build>Install & Build</h3>
<p>First, we need to install terraform. The guide provides a link to the binaries but I decided to install it using <a href=https://brew.sh/>Homebrew</a>.</p>
<p><code>$brew install terraform</code><br>
<code>$terraform version #verify it was installed properly</code></p>
<p>After the installation, we start to <a href=https://www.terraform.io/intro/getting-started/build.html>build basic infrastructure</a> on AWS. First, we create a Terraform configuration file(.tf) and copy and paste our access keys for now. We can figure out the keys on <a href=https://console.aws.amazon.com/iam/home?#security_credential>AWS’s IAM console</a>. I created a pair easily by clicking on “Create new access key”. Then, we do $terraform init which basically is the “mise en place” or the initial configuration to start building the infrastructure. We can see how Terraform plans to create(or modify) the infrastructure with: <code>$terraform plan</code>. If we get no errors back we can go ahead and proceed with apply: <code>$terraform apply</code>. Which creates the instance. We can then do <code>$terraform show</code> to check the state. The guide asks that we check the console to confirm the instance was created. However, this was not the case for me! I tried looking for any report of this error online but found nothing. Similarly, I couldn’t find the ami “ami-2757f631”, my guess is that the instance is not provided by Amazon anymore. The fine print in the guide states that:</p>
<p><strong>Note</strong>: The above configuration is designed to work on most EC2 accounts, with access to a default VPC. For EC2 Classic users, please use t1.micro for instance_type, and ami-408c7f28for the ami. If you use a region other than us-east-1 then you will need to choose an AMI in that region as AMI IDs are region specific.</p>
<p>Some new terms for me. <a href=http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Introduction.html>Amazon</a> defines VPC(Virtual Private Cloud) as a virtual network that resembles the network in a data center. Also, EC3 Classic only applies to accounts created before <a href=http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-vpc.html>2013-12-04</a>. Since the next chapter in the guide is about deleting and modifying infrastructure, I’m going to keep going to see if changing the ami solves the issue.</p>
<h3 id=change-the-infrastructure>Change the Infrastructure</h3>
<p>The guide wants us to modify the ami and see how Terraform handles the change. It asks to change to ami-b374d5a5. However, after looking for this ami I cannot find any reference on the ami section of the EC2 dashboard. I’m going to change it to ami-da786da3 which is Suse Enterprise 12. I chose this image from the ‘launch instance’ menu. I did<code> $terraform apply</code> and I got the following error:</p>
<p>Error applying plan:1 error(s) occurred:* aws_instance.example: 1 error(s) occurred:* aws_instance.example: Error launching source instance: InvalidAMIID.NotFound: The image id &lsquo;[ami-da786da3]&rsquo; does not exist        status code: 400, request id: ccf07eee-c5c9-4204-b308-0614e2915af8Terraform does not automatically rollback in the face of errors.Instead, your Terraform state file has been partially updated withany resources that successfully completed. Please address the errorabove and apply again to incrementally change your infrastructure.</p>
<p>Which points to the error being my fault. Terraform does correctly give an error message when a wrong image is used. Though in hindsight, I think it would be better to know in the plan stage not after the previous instance was destroyed. Now, I have two doubts: (1) What console am I supposed to find the instance? (2) Where are the appropriate images?</p>
<p>I’m going to change the ami to what the guide suggest: ami-b374d5a5.  Then $terraform plan & $terraform apply. No errors.</p>
<p>I found the issue! Turns out, I was in the wrong region on the console! I was looking at the west region, where the blog resides. The guide, however, is working in the East region. I’m going to try to modify the configuration with a Suse image from this region. AMI being ami-8fac8399.</p>
<p>aws_instance.example: Creation complete after 51s (ID: i-0a3da5f272e78ec90)Apply complete! Resources: 1 added, 0 changed, 1 destroyed.</p>
<p>Success!</p>
<h3 id=destroy>Destroy</h3>
<p>Next step on the guide is to destroy. We can see what’s going to be destroyed with $terraform plan -destroy. Then we can destroy with: $terraform destroy after which we get prompted to confirm we want to delete the resources.</p>
<h3 id=resource-dependencies--provision>Resource Dependencies & Provision</h3>
<p>In this section, we are introduced to configurations with multiple resources and dependencies between resources. We start by assigning an elastic IP to the EC2 instance by adding an “aws_ip” resource to the configuration. In this new resource we interpolate the instance ID using a reference:instance = “${aws_instance.example.id}” . When we do $terraform plan we can still see the value since its interpolated once the resource is created. After $terraform apply we notice an order in the creation of the resources, first the instance then the elastic IP. This is an implicit dependency, terraform takes care of this automatically. We can also create explicit dependencies with the “depends_on” parameter.</p>
<p>We run $terraform destroy and move onto the next part of the guide, Provision. Provisioners are introduced as a way to do some initial setup on instances, be it running scripts or a configuration management tool. As an example, we add a provisioner to the example instance which runs the command “echo ${aws_instance.example.public_ip} > ip_address.txt” when the instance is created. If the provisioning fails, the resource is marked as tainted and destroyed and recreated on the next execution plan. Finally, there are also destroy provisioners that are executed during the destroy phase.</p>
<h3 id=input--output-variables>Input & Output Variables</h3>
<p>In this section we’re introduced to variables as a way to make configurations shareable & version controlled. As an example, we create variables for the access keys as they are hardcoded at the moment. First we create a file(variables.tf) to declare our variables and replace these names in the configuration. Now when we $terraform plan we are asked for the values of these variables. We can assign  the values as command-line flags, set them in a separate file or set them in environment variables.  We can also create lists and maps. For the example we create a map with amis for each region. Finally, we can also create output variables which serve as a way to organize output data that can be queried by the user.</p>
<h3 id=modules--remote-backends>Modules & Remote Backends</h3>
<p>Since modules require non-free tier usage of AWS I’m going to skip the hands-on part of the tutorial. Modules are a way to make components reusable and help organize the workflow. To me, the most interesting part of the modules is the source field in the module declaration. In this example, we create a Consul cluster from a configuration that is saved as part of the GitHub project: <code>source = "github.com/hashicorp/consul/terraform/aws"</code>. Finally, remote backends are a way to handle terraform in production. As the guide says, remote backends are used to run terraform remotely and store a master Terraform state remotely.</p>
<h2 id=conclusion>Conclusion</h2>
<p>I learn a few important lessons from working through this tutorial:</p>
<ul>
<li>I got an overview of a cool way to manage all this infrastructure in a clever and organized way.</li>
<li>Read and Understand the fine print in guides! Or anywhere for that matter</li>
<li>I learned more about the features of AWS and to be aware of the regions.</li>
</ul>
<p>Looking forward to the conference and learning about Terraform. Catch you on the next one!</p>
</div>
</article>
<div class="nav-bkg-50 content-container-narrow-pad bottom-links text-0p75 drop-shadow">
<nav class=flex-row>
<a href=https://crmejia.github.io/posts/july-august-2017-my-first-prs/ class="flex-row v-center no-underline" style=max-width:45%>
<span class=text-1p5>←</span>&nbsp;<span class=re-underline>Previous: July & August 2017: My first PRs</span>
</a>
<a href=https://crmejia.github.io/posts/creating-a-simple-cluster-with-terraform/ class="flex-row v-center no-underline" style=max-width:45%>
<span class=re-underline>Next: Creating a Simple Cluster with Terraform</span>&nbsp;<span class=text-1p5>→</span>
</a>
</nav>
</div>
</body>
</html>
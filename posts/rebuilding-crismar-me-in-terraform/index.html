<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
<meta charset=utf-8>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=apple-touch-icon sizes=180x180 href=https://crmejia.github.io/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://crmejia.github.io/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://crmejia.github.io/favicon-16x16.png>
<link rel=manifest href=https://crmejia.github.io/site.webmanifest>
<link rel=mask-icon href=https://crmejia.github.io/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<meta name=description content="It's been a while since I've maintained the blog. So instead of upgrading everything manually I've just decided to rewrite everything in Terraform and migrate the data">
<meta name=keywords content="Digital Ocean,
Terraform,
Ghost,
nginx,
">
<meta property="og:title" content="Rebuilding crismar.me in Terraform">
<meta property="og:description" content="It's been a while since I've maintained the blog. So instead of upgrading everything manually I've just decided to rewrite everything in Terraform and migrate the data">
<meta property="og:type" content="article">
<meta property="og:url" content="https://crmejia.github.io/posts/rebuilding-crismar-me-in-terraform/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-16T21:57:41+00:00">
<meta property="article:modified_time" content="2021-08-16T21:57:41+00:00">
<meta property="og:site_name" content="Crismar.Me">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Rebuilding crismar.me in Terraform">
<meta name=twitter:description content="It's been a while since I've maintained the blog. So instead of upgrading everything manually I've just decided to rewrite everything in Terraform and migrate the data">
<meta itemprop=name content="Rebuilding crismar.me in Terraform">
<meta itemprop=description content="It's been a while since I've maintained the blog. So instead of upgrading everything manually I've just decided to rewrite everything in Terraform and migrate the data"><meta itemprop=datePublished content="2021-08-16T21:57:41+00:00">
<meta itemprop=dateModified content="2021-08-16T21:57:41+00:00">
<meta itemprop=wordCount content="461">
<meta itemprop=keywords content="Digital Ocean,Terraform,Ghost,nginx,">
<title>Rebuilding crismar.me in Terraform || Crismar.Me</title>
<link rel=canonical href=https://crmejia.github.io/posts/rebuilding-crismar-me-in-terraform/>
<link rel=stylesheet href=/css/reboot.css>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/syntax.css>
<script type=text/javascript src=/js/main.js></script>
<link href="https://fonts.googleapis.com/css?family=Lora&display=swap" rel=stylesheet>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/apple-touch-icon.png>
</head>
<body class=look-sheet-bkg lang=en-us>
<div class="navbar nav-bkg drop-shadow">
<nav class="content-container pagewide-bar-padding">
<span class=divider>/ </span>
<a href=/>Crismar.Me</a>
<span class=divider>/ </span>
<a href=/posts/>Posts</a>
<ul class="list-unstyled right-links">
<li>
<a href=/about/>
<span class=post-title>about</span>
</a>
</li>
<li>
<a href=/posts/>
<span class=post-title>blog</span>
</a>
</li>
<li>
<a href=/consulting/>
<span class=post-title>consulting</span>
</a>
</li>
</ul>
</nav>
</div>
<article id=main class="content-container look-sheet article-pad-v" itemscope itemtype=https://schema.org/Article>
<meta itemprop=author content>
<meta itemprop=publisher content>
<meta itemprop=image content>
<h1 itemprop=name id=title>Rebuilding crismar.me in Terraform</h1>
<meta itemprop=headline content="Rebuilding crismar.me in Terraform">
<div class=post-tags>
<a href=https://crmejia.github.io/tags/digital-ocean/>#Digital Ocean</a>&nbsp;
<a href=https://crmejia.github.io/tags/terraform/>#Terraform</a>&nbsp;
<a href=https://crmejia.github.io/tags/ghost/>#Ghost</a>&nbsp;
<a href=https://crmejia.github.io/tags/nginx/>#nginx</a>&nbsp;
</div>
<div class=post-date><span itemprop=datePublished>August 16, 2021</span></div>
<meta itemprop=dateModified content="August 16, 2021">
<div itemprop=articleBody id=content class="article-body margin-top-2em">
<p>Howdy. It&rsquo;s been a while since I&rsquo;ve maintained the blog. So instead of upgrading everything manually I&rsquo;ve just decided to rewrite everything in Terraform and migrate the data.</p>
<h2 id=create-the-new-droplet-using-terraform>Create the new Droplet using Terraform</h2>
<p>First, we need to set up the Digital Ocean <a href=https://registry.terraform.io/providers/digitalocean/digitalocean/latest/docs>Terraform provider</a> following this <a href=https://www.digitalocean.com/community/tutorials/how-to-use-terraform-with-digitalocean>guide</a>. I added my token as an environment variable. Afterwards, we can create the droplet itself following the digital ocean droplet resource <a href=https://registry.terraform.io/providers/digitalocean/digitalocean/latest/docs/resources/droplet>docs</a>. I&rsquo;ve published the <a href=https://github.com/crmejia/crismar.me>code</a> on GitHub if you want to have a look.</p>
<h2 id=setting-up-https-for-wwwcrismarme>Setting up HTTPS for <a href=http://www.crismar.me>www.crismar.me</a></h2>
<p>After the initial setup I tried accessing <a href=http://www.crismar.me>www.crismar.me</a> but the browser complained that the certificate was invalid as it&rsquo;s only valid for crismar.me. After some googling, I found this <a href=https://ghost.org/docs/ghost-cli/#ssl>guide</a> that explains how to setup ssl for additional domains.</p>
<p>The tl;dr is that we need to re-run the ghost config with the additonal domain so that ghost generates a new cert and a new nginx conf. Afterwards, we reset to the canonical domain and change the nginx confs of the additional domain to redirect to the canonical domain. Here&rsquo;s a step by step walkthough as there are something that are not obvious:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#ssh into your droplet and swith to the ghost usr</span>
sudo -i -u ghost-mgr

<span style=color:#75715e>#cd into the blog directory and the run the config</span>
cd /var/www/ghost/
ghost config url https://www.crismar.me
ghost setup nginx ssl

<span style=color:#75715e>#then reconfig to the original url and exit to the root usr</span>
ghost config url https://crismar.me
exit
</code></pre></div><p>The next on the guide is to change the <code>location</code> blocks content to be <code>return 301 [https://my-canonical-domain.com$request_uri;](https://my-canonical-domain.com$request_uri;</code>)<code>that is a redirect. However, this instruction is vague if you're not familiar with how nginx works. The general idea, is that the confs are kept under</code>/etc/nginx/sites-available<code>and</code>/etc/nginx/sites-enabled` , the latter being symbolic links to the former:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># ls -l  sites-*</span>
sites-available:
total <span style=color:#ae81ff>24</span>
-rw-rw-r-- <span style=color:#ae81ff>1</span> ghost-mgr ghost-mgr  <span style=color:#ae81ff>749</span> Aug <span style=color:#ae81ff>11</span> 22:16 crismar.me-ssl.conf
-rw-rw-r-- <span style=color:#ae81ff>1</span> ghost-mgr ghost-mgr  <span style=color:#ae81ff>546</span> Aug <span style=color:#ae81ff>11</span> 22:15 crismar.me.conf
-rw-r--r-- <span style=color:#ae81ff>1</span> root      root      <span style=color:#ae81ff>2416</span> Mar <span style=color:#ae81ff>26</span>  <span style=color:#ae81ff>2020</span> default
-rw-rw-r-- <span style=color:#ae81ff>1</span> ghost-mgr ghost-mgr  <span style=color:#ae81ff>553</span> Aug <span style=color:#ae81ff>16</span> 21:08 www.crismar.me-ssl.conf
-rw-rw-r-- <span style=color:#ae81ff>1</span> ghost-mgr ghost-mgr  <span style=color:#ae81ff>337</span> Aug <span style=color:#ae81ff>16</span> 21:08 www.crismar.me.conf

sites-enabled:
total <span style=color:#ae81ff>0</span>
lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>46</span> Aug <span style=color:#ae81ff>11</span> 22:16 crismar.me-ssl.conf -&gt; /etc/nginx/sites-available/crismar.me-ssl.conf
lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>42</span> Aug <span style=color:#ae81ff>11</span> 22:15 crismar.me.conf -&gt; /etc/nginx/sites-available/crismar.me.conf
lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>50</span> Aug <span style=color:#ae81ff>16</span> 20:56 www.crismar.me-ssl.conf -&gt; /etc/nginx/sites-available/www.crismar.me-ssl.conf
lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>46</span> Aug <span style=color:#ae81ff>16</span> 20:55 www.crismar.me.conf -&gt; /etc/nginx/sites-available/www.crismar.me.conf

</code></pre></div><p>So we only need to make changes under <code>/etc/nginx/sites-available</code> . So in our case we would modify both <code>www.crismar.me.conf</code> and <code>www.crismar.me-ssl.conf</code> by changing everything inside the first location block to redirect to the canonical domain <code>crismar.me</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>location / <span style=color:#f92672>{</span>
       <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>301</span> https://crismar.me$request_uri;
    <span style=color:#f92672>}</span>
</code></pre></div><p>Then test that the config is valid and reload the daemon:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nginx -t 
sudo nginx -s reload
</code></pre></div><p>and voila the new blog is ready to go!</p>
</div>
</article>
<div class="nav-bkg-50 content-container-narrow-pad bottom-links text-0p75 drop-shadow">
<nav class=flex-row>
<a href=https://crmejia.github.io/posts/january-february-18-reactiveops-career-goals-pycaribbean/ class="flex-row v-center no-underline" style=max-width:45%>
<span class=text-1p5>←</span>&nbsp;<span class=re-underline>Previous: January & February '18: ReactiveOps, Career Goals, PyCaribbean</span>
</a>
<a href=https://crmejia.github.io/posts/city_guide/ class="flex-row v-center no-underline" style=max-width:45%>
<span class=re-underline>Next: CityGuide: Go WebApp to Share Locations</span>&nbsp;<span class=text-1p5>→</span>
</a>
</nav>
</div>
</body>
</html>